#!/bin/ash
# mounts and returns mount point
# return mount point if partition already mounted
# any error: return -ne 0

MNT_DEV="$1"  #ex: /dev/sda1
MNT_DIR="$2"  #ex: /mnt/sda1
MNT_FS="$3"    #ex: vfat
[ "$1" = "" ] && exit 1

#-----------------------------------------------------

xdev=${MNT_DEV##*/} #basename
if [ ! -b /dev/$xdev ] ; then
  echo "$xdev: not a valid block device" 1>&2
  exit 1
fi
MNT_DEV=/dev/$xdev

IS_MOUNTED=$(mount | grep "^/dev/$xdev " | cut -f 3 -d ' ')
if [ "$IS_MOUNTED" ] ; then
  [ ! "$INIT_SCRIPT" ] && echo $IS_MOUNTED
  exit
fi

[ -z "$MNT_DIR" ] && MNT_DIR=/mnt/$xdev
[ -z "$MNT_FS" ]  && MNT_FS=$(blkid /dev/$xdev 2>/dev/null | grep -o ' TYPE=".*"' | cut -f 2 -d '"')
mkdir -p ${MNT_DIR}

#-----------------------------------------------------

MNT_O='noatime'

case $MNT_FS in
  ntfs)
    
    #Check if the kernel has builtin ntfs3 support
    if [ "$(grep -m 1 'ntfs3' /proc/filesystems)" != "" ]; then
     USE_NTFS3="y"
     KVER=$(uname -r)
     KMAJOR=$(echo "$KVER" | cut -f 1 -d '-' | cut -f 1 -d '.')
     KMINOR=$(echo "$KVER" | cut -f 1 -d '-' | cut -f 2 -d '.')
    else
     USE_NTFS3=""
    fi
    
    if [ "$USE_NTFS3" != "" ]; then
       if [ $KMAJOR -ge 6 ] && [ $KMINOR -ge 2 ]; then
        #Mount ntfs partition but respect windows filesystem setup. Only available on linux kernel 6.2 onwards
        mount -t ntfs3 -o umask=0,noatime,prealloc,iocharset=utf8,nocase,windows_names $MNT_DEV $MNT_DIR
       else
        mount -t ntfs3 -o umask=0,noatime,prealloc,iocharset=utf8 $MNT_DEV $MNT_DIR
       fi
    else
    
      ntfs-3g $MNT_DEV $MNT_DIR -o umask=0,no_def_opts,noatime,rw,silent 2>/dev/null #default is rw. 130211 add silent.
    
      case $? in
        0)  RET=0 ;;
        14) echo "\\033[1;31m_WINDOWS_HIBERNATED_\\033[0;39m" >/dev/console ;; #31=red
        *)  ntfs-3g $MNT_DEV $MNT_DIR -o umask=0,no_def_opts,noatime,rw,force,silent 2>/dev/null ;; #130211 add silent.
      esac
    
    fi
    ;;
  vfat)
    VFAT_OUT_PARAM='noatime,shortname=mixed,quiet,utf8' 
    if [ -f /tmp/vfatmount ] ; then
      read VFAT_OUT_PARAM < /tmp/vfatmount #/sbin/set_plang
    fi
    mount -t $MNT_FS -o $VFAT_OUT_PARAM $MNT_DEV $MNT_DIR ;;
  #exfat) mount.exfat-fuse -o $MNT_O $MNT_DEV $MNT_DIR ;;
  *)
     mount -t $MNT_FS -o $MNT_O $MNT_DEV $MNT_DIR
     ;;
esac

RET=$?
[ "$RET" = "0" ] && [ ! "$INIT_SCRIPT" ] && echo $MNT_DIR
exit $RET

### END ###
