#!/bin/sh
#(c) Barry Kauler, April 2009. GPL v3 licence (refer: /usr/share/doc/legal).
#gui for 'bcrypt' file encrypt/decrypt.
#$1 is normally invoked by clicking on a .bfe file in rox, $1 has full path.
#also supports drag and drop.
#most of this code was written by coolpup, I have just butchered it a bit.
#w482 dogone: password must be 8 chars, logic fixed.
#120201 rodin.s: internationalized.
#120226 01micko: convert to gtkdialog4.
#120323 call pupmessage instead of xmessage.
#131130 zigbert: gui (gtkdialog) improvements.

export TEXTDOMAIN=bcrypt_gui
export TEXTDOMAINDIR=/usr/share/locale
export OUTPUT_CHARSET=UTF-8
. gettext.sh
export LANGORG=$LANG

if [ "`which bcrypt`" = "" ];then
 pupmessage -center -bg red -title "$(gettext 'Bcrypt error')" "$(gettext "The 'bcrypt' package must be installed first.")"
 exit
fi

#if [ ! $1 ];then
 #run from the menu. this section was originally created by 'coolpup', jan. 2009.
 #modified by BK april 2009.
 SOURCEFILE=""
 if [ $1 ];then
  SOURCEFILE="$1"
  [ ! -f "$SOURCEFILE" ] && exit
 fi
 
 while [ 1 ];do
  if [ "$SOURCEFILE" = "" ];then
   DEFAULT=""
  else
   DEFAULT="<default>${SOURCEFILE}</default>"
  fi

  #build svg
  echo '<?xml version="1.0" encoding="UTF-8"?>
  <svg viewBox="-100 0 330 330" version="1.0">
  <path style="fill:#DDDEBC;stroke:#555555;stroke-width:5;" d="M -66,40 -66,280 127,280 127,97 67,97 68,40 z"/>
  <path style="stroke:#555555;stroke-width:5;" d="M 67,40 125,97"/>
  <path fill="#333333" d="m 96,50 c -27,1 -55,9 -70,34 -10,16 -5,42 -7,60 0,0 -18,0 -24,0 0,40 -1,81 -1,121 3,25 28,45 53,43 38,0 76,0 114,0 16,-4 43,-21 43,-41 0,-43 -2,-80 -2,-122 -8,0 -15,0 -23,0 1,-8 4,-41 -9,-61 -19,-25 -48,-32 -75,-32 z m 60,60 c 0,12 0,23 -1,33 -38,0 -76,0 -114,0 0,-14 0,-21 1,-35 0,-22 30,-37 55,-36 25,1 56,7 58,38 z m -58,66 c 22,1 28,30 12,43 3,9 10,42 12,53 -16,0 -32,0 -48,0 3,-18 9,-35 12,-53 -16,-15 -11,-42 12,-43 z"/>
  </svg>' > /tmp/bcrypt.svg

  #main gui
  export Bcrypt='
<window title="Bcrypt - '$(gettext 'File encryption')'" icon-name="gtk-file" window_position="1" default_height="300" default_width="460">
<vbox space-expand="true" space-fill="true">

  <hbox scrollable="true" shadow-type="3" vscrollbar-policy="2" hscrollbar-policy="2" space-expand="true" space-fill="true">
    <vbox space-expand="false" space-fill="false">
      <text height-request="5"><label>""</label></text>
      <hbox border-width="10" spacing="15">
        <vbox>
          <pixmap>
            <input file>/tmp/bcrypt.svg</input>
            <height>60</height>
          </pixmap>
        </vbox>
        <vbox>
          <text xalign="0" space-expand="false" space-fill="false"><label>'$(gettext "Bcrypt is a utility to encrypt or decrypt a file")'</label></text>
          <text xalign="0" use-markup="true" space-expand="false" space-fill="false"><label>"'$(gettext "Drag the file you want to <b>encrypt or decrypt</b> into the field or use the browse-button.")'"</label></text>
          <text xalign="0" use-markup="true" space-expand="false" space-fill="false"><label>"<b><span color='"'red'"'>'${MSG2}'</span></b>"</label></text>         
        </vbox>
      </hbox>
    </vbox>
    <text space-expand="true" space-fill="true"><label>""</label></text>
  </hbox>



  <vbox space-expand="false" space-fill="false">
    <frame '$(gettext 'File')'>
      <hbox>
        <text><label>"'$(gettext 'File to encrypt / decrypt')' "</label></text>
        <entry accept="file" fs-title="Bcrypt">
          '${DEFAULT}'
          <variable>SOURCEFILE</variable>
        </entry>
        <button>
          <input file stock="gtk-open"></input>
          <action type="fileselect">SOURCEFILE</action>
        </button>
      </hbox>
      <text space-expand="true" space-fill="true"><label>""</label></text>
      <hbox>
        <text><label>"'$(gettext 'Enter password')' "</label></text>
        <entry width-request="200" space-expand="false" space-fill="false">
           <visible>password</visible>
           <variable>PASSWORD1</variable>
        </entry>
      </hbox>
      <hbox>
        <text><label>"'$(gettext 'Reenter password')' "</label></text>
        <entry width-request="200" space-expand="false" space-fill="false">
          <visible>password</visible>
          <variable>PASSWORD2</variable>
          <action signal="activate">exit:OK</action>
        </entry>
      </hbox>
    </frame>
  </vbox>
  <hbox space-expand="false" space-fill="false"> 
    <hbox space-expand="false" space-fill="false"> 
      <button help><action>bcrypt_gui_help</action></button>
    </hbox>
    <text space-expand="true" space-fill="true"><label>""</label></text>
    <button cancel></button>
    <button ok></button>
  </hbox>
</vbox>
</window>'

  RETVALS="`gtkdialog -p Bcrypt`"
  eval "$RETVALS"
  [ "$EXIT" != "OK" ] && break
  [ "$PASSWORD1" = "" ] && break
  [ "$PASSWORD2" = "" ] && break
  [ "$SOURCEFILE" = "" ] && break
  [ ! -f "$SOURCEFILE" ] && break
  BYTES1=`echo -n "$PASSWORD1" | wc -c`
  if [ $BYTES1 -lt 8 ];then #w482 dogone advised, change from -le.
   MSG2="$(gettext 'Password needs to be at least 8 characters!')"
   continue
  fi
  if [ "$PASSWORD1" != "$PASSWORD2" ];then
   MSG2="$(gettext 'The password entries do not match!')"
   continue
  fi
  
  DIRNAME="`dirname "$SOURCEFILE"`"
  BASENAME="`basename "$SOURCEFILE"`"
  cd "$DIRNAME"
  if [ "`echo "$BASENAME" | grep '\.bfe$'`" != "" ];then
   echo "$PASSWORD1" | bcrypt $BASENAME 2>/tmp/bcrypt_error
  else
   echo "$PASSWORD1
$PASSWORD2" | bcrypt $BASENAME 2>/tmp/bcrypt_error
  fi
  if [ $? -ne 0 ];then
   MSG2="`cat /tmp/bcrypt_error | tail -n 1`"
   continue
  fi
  
  break
 done

 exit
#fi

###END###
