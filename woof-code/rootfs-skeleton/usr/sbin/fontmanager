#!/bin/bash

export TEXTDOMAIN=fontmanager
export OUTPUT_CHARSET=UTF-8

export antialiasing=$(grep '<bool>' $HOME/.fonts.conf|head -1|cut -d '>' -f2|cut -d '<' -f1)
export hinting=$(grep '<bool>' $HOME/.fonts.conf|head -2|tail -1|cut -d '>' -f2|cut -d '<' -f1)
export autohint=$(grep '<bool>' $HOME/.fonts.conf|head -3|tail -1|cut -d '>' -f2|cut -d '<' -f1)
[ "$antialiasing" = "" ] && antialiasing=false hinting=false autohint=false
                        
save_settings(){
	case $hinting in
	  true)
		hintstyle=hintslight
		;;
	  false)
		hintstyle=hintnone
		;;
	esac

	echo "<match target=\"font\">
	<edit name=\"antialias\" mode=\"assign\">
	  <bool>$antialiasing</bool>
	</edit>
	<edit name=\"hinting\" mode=\"assign\">
	  <bool>$hinting</bool>
	</edit>
	<edit name=\"autohint\" mode=\"assign\">
	  <bool>$autohint</bool>
	</edit>
	<edit name=\"hintstyle\" mode=\"assign\">
	  <const>$hintstyle</const>
	</edit>
	</match>" > $HOME/.fonts.conf

	rm /etc/fonts/local.conf
	ln -s $HOME/.fonts.conf /etc/fonts/local.conf
 }

export -f save_settings

infobox (){
	#generate xml-code for info box, used several times in gui
	echo '
	<hbox scrollable="true" shadow-type="3" vscrollbar-policy="2" hscrollbar-policy="2" space-expand="true" space-fill="true">
	  <vbox space-expand="false" space-fill="false">
		<text height-request="5"><label>""</label></text>
		<hbox>
		  <vbox><pixmap><input file stock="gtk-info"></input></pixmap></vbox>
		  <vbox space-expand="false" space-fill="false">
		    <text xalign="0" use-markup="true"><label>"'$1'"</label></text>
		    <text xalign="0" use-markup="true"><label>"'$2'"</label></text>
		    <text xalign="0" use-markup="true"><label>"'$3'"</label></text>
		    <text xalign="0" use-markup="true"><label>"'$4'"</label></text>
		  </vbox>
		</hbox>
	  </vbox>
	  <text space-expand="true" space-fill="true"><label>""</label></text>
	</hbox>'
}

export Font_Manager='
<window title="'$(gettext 'Font Manager')'" icon-name="gtk-execute" default_height="400" default_width="480"> 
<vbox space-expand="true" space-fill="true">
  <notebook tab-pos="2" page="0" labels="'$(gettext 'Size')'|'$(gettext 'Appearance')'">


    <frame '$(gettext 'Font Appearance')'>
      '"`infobox "$(gettext "You can change the way fonts appear on your screen: make them either sharper or smoother.")" "$(gettext "For LCD it is recommend to turn everything on. For CRT screens, do the opposite.")"`"'        
      <vbox space-expand="false" space-fill="false">
        <text height-request="20"><label>""</label></text>
        <checkbox tooltip-text="'$(gettext "If checked, fonts will be smoothed with antialiasing.")'">
          <label>'$(gettext 'Antialiasing')'</label>
          <variable>antialiasing</variable>
          <default>'$antialiasing'</default>
        </checkbox>
        <checkbox tooltip-text="'$(gettext "If checked, fonts will be smoothed with hinting.")'">
          <label>'$(gettext 'Hinting')'</label>
          <variable>hinting</variable>
          <default>'$hinting'</default>
        </checkbox>
        <checkbox>
          <label>'$(gettext 'Automatic hinting')'</label>
          <variable>autohint</variable>
          <default>'$autohint'</default>
        </checkbox>
        <text height-request="20"><label>""</label></text>
        </vbox>
      </frame>


    </notebook>
    <hbox space-expand="false" space-fill="false">
      <text use-markup="true" space-expand="false" space-fill="false"><label>" <b>'$(gettext 'Restart application to take affect.')'</b>"</label></text>
      <text space-expand="true" space-fill="true"><label>""</label></text>
      <button ok><action type="exit">save</action></button> 
      <button cancel><action type="exit">EXIT_NOW</action></button> 
    </hbox>
  </vbox>
</window>'

eval $(gtkdialog -p Font_Manager)

[ "$EXIT" = "save" ] && save_settings
