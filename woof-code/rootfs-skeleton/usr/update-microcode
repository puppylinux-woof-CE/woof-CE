#!/bin/sh
#manually update cpu microcode
#written by mistfire

 if [ "$(uname -m | grep -E '^x86_64|^amd64|^i.86')" == "" ]; then
  echo "Not x86/x64 CPU"
  exit
 fi	
 
 VCPU=""
 
 [ "$(dmesg | grep -m 1 "Hypervisor detected")" != "" ] && VCPU="y"
 [ "$(dmesg | grep -m 1 "Booting paravirtualized kernel on")" != "" ] && VCPU="y"
  
 if [ "$VCPU" != "" ]; then
  echo "Not a physical machine"
  exit
 fi
 
 if [ ! -e /sys/devices/system/cpu/microcode/reload ]; then
   echo "Microcode late loading not supported."
   exit  
 fi

  xCPU=""
  
  [ "$(cat /proc/cpuinfo | grep -m 1 "Intel")" != "" ] && xCPU='intel' 
  
  if [ "$xCPU" == "" ]; then
   [ "$(cat /proc/cpuinfo | grep -m 1 "AMD")" != "" ] && xCPU='amd'   
  fi
   
  if [ "$xCPU" != "" ]; then
   if [ -e /lib/firmware/${xCPU}-ucode ] || [ -e /usr/lib/firmware/${xCPU}-ucode ]; then
     echo "Reloading $xCPU microcode..."
     echo 1 > /sys/devices/system/cpu/microcode/reload
     echo "Done"
   fi
  else
   echo "Not Intel or AMD CPU"
   exit
  fi
