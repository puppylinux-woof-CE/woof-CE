#!/bin/sh
#manually update cpu microcode
#written by mistfire

 if [ "$(uname -m | grep -E '^x86_64|^amd64|^i.86')" == "" ]; then
  echo "Not x86/x64 CPU"
  exit
 fi	

 if [ "$(which lscpu)" == "" ]; then
  echo "lscpu is missing"
  exit
 fi
 
 if [ "$(lscpu | grep "Hypervisor")" != "" ]; then
  echo "Not a physical CPU"
  exit
 fi
 
 if [ ! -e /sys/devices/system/cpu/microcode/reload ]; then
   echo "Microcode late loading not supported."
   exit  
 fi

  xCPU=""
  
  [ "$(lscpu | grep "Intel")" != "" ] && xCPU='intel' 
  
  if [ "$xCPU" == "" ]; then
   [ "$(lscpu | grep "AMD")" != "" ] && xCPU='amd'   
  fi
   
  if [ "$xCPU" != "" ]; then
   if [ -e /lib/firmware/${xCPU}-ucode ] || [ -e /usr/lib/firmware/${xCPU}-ucode ]; then
     echo "Reloading $xCPU microcode..."
     echo 1 > /sys/devices/system/cpu/microcode/reload
     echo "Done"
   fi
  else
   echo "Not Intel or AMD CPU"
   exit
  fi
