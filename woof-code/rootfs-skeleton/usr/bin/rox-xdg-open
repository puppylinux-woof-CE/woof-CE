#!/bin/sh
#This script looks for appropriate program to open a file by searching in mimeapps.list and mimeinfo.cache
#works the same as xdg-open but for rox-filer use only

whole_args="$@"

mimetype1="$(gvfs-info -a standard::content-type "$1" | grep "content-type:"| cut -f 4 -d ':' | sed -e "s#^\ ##g" -e "s#\-#\\\-#g")"

echo "mimetype: $mimetype1"

exec_desktop(){

app2="$1"

    if [ -e "$HOME/.local/share/applications/$app2" ]; then
     execpath1="$HOME/.local/share/applications/$app2"
    elif [ -e "/usr/share/applications/$app2" ]; then
     execpath1="/usr/share/applications/$app2"
    elif [ -e "/usr/local/share/applications/$app2" ]; then
     execpath1="/usr/local/share/applications/$app2"
    fi
    
    if [ "$execpath1" != "" ]; then
     echo "Execute: $(grep "^Exec" "$execpath1" | sed 's/Exec=//;s/%[a-zA-Z]//') \"$whole_args\""
     exec $(grep "^Exec" "$execpath1" | sed 's/Exec=//;s/%[a-zA-Z]//') "$whole_args"
     exit 0
    else
     exit 1
    fi

}

look_file_association(){

path2="$1"

if [ -e "$path2/mimeapps.list" ]; then
 dfiles="$(sed -n -e '/\[Default\ Applications\]/,//p' "$path2/mimeapps.list" | grep "$mimetype1=" | cut -f 2 -d '=' | tr ';' ' ')"
 echo "$path2/mimeapps.list: $dfiles"
 if [ "$dfiles" != "" ]; then
   for app1 in $dfiles
   do
    exec_desktop "$app1"
   done
 fi
fi

if [ -e "$path2/mimeinfo.cache" ]; then
 dfiles="$(cat "$path2/mimeinfo.cache" | grep "$mimetype1=" | cut -f 2 -d '=' | tr ';' ' ')"
 echo "$path2/mimeinfo.cache: $dfiles"
 if [ "$dfiles" != "" ]; then
   for app1 in $dfiles
   do
    exec_desktop "$app1"
   done
 fi
fi

}

for xdg_path in "$HOME/.local" /usr /usr/local
do
 [ -e "$xdg_path" ] && look_file_association "$xdg_path/share/applications"
done

exit 1
