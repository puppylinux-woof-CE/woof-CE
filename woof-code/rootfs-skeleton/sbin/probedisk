#!/bin/sh
#LGPL 2007 Puppy Linux www.puppyos.com
#based on probedisk3 written by Dougal.
# 21 Jun 2007 BK: force /proc update for usb drives.
#v3.93 10 dec 2007 BK: updated for 2.6.24 kernel, no /dev/hd*.
#v406 support for old kernel, /proc/ide, /dev/hd*.
# DEVICE|TYPE|INFO

if [ -f $HOME/.usb-drive-log-probedisk ] ; then #force /proc upate mechanism
  while read ONEUSBDRV ; do
    dd if=/dev/$ONEUSBDRV of=/dev/null bs=512 count=1 &>/dev/null
  done < $HOME/.usb-drive-log-probedisk
fi

ALLDRVS=$(ls /sys/block | grep -E '^scd|^sd|^mmc|^sr')
if [ -e /proc/ide ] ; then
  PROCIDE=1
  ALLDRVS="$ALLDRVS
$(ls /proc/ide | grep '^hd')"
fi

for p in ${ALLDRVS} ; do
	#case $p in ram*|nbd*|loop*) continue;; esac
	USB=0
	vendor="" model="" type="drive"
	[ -f /sys/block/$p/device/vendor ] && read vendor < /sys/block/$p/device/vendor
	[ -f /sys/block/$p/device/model ] && read model < /sys/block/$p/device/model
	info="$vendor $model"
	case $p in
		hd*) ## ide device, look in /proc/ide for info
			read -r media < /proc/ide/$p/media
			[ "$media" = "cdrom" ] && type="optical"
			[ -f /proc/ide/$p/model ] && read info < /proc/ide/$p/model
			;;
		sd*) [ "$PROCIDE" ] && type=usbdrv && USB=1 ;; ## /proc/ide: flash drives appear as sdX)
		fd*)      type=floppy  ;;
		scd*|sr*) type=optical ;; #scd*: probably old stuff
		mmc*)     type=card    ;;
	esac
	readlink /sys/block/$p | grep -q usb && USB=1
	if [ $USB -eq 1 ] ; then
		type=usbdrv
		echo "$p" >> $HOME/.usb-drive-log-probedisk
		sorted="$(sort -u $HOME/.usb-drive-log-probedisk)"
		echo "$sorted" > $HOME/.usb-drive-log-probedisk
	fi
	echo "/dev/$p|$type|$info"
done

### END ###