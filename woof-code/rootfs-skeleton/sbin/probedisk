#!/bin/sh
# DEVICE|TYPE|INFO

if [ -f $HOME/.usb-drive-log-probedisk ] ; then #force /proc upate mechanism
  while read ONEUSBDRV ; do
    dd if=/dev/$ONEUSBDRV of=/dev/null bs=512 count=1 &>/dev/null
  done < $HOME/.usb-drive-log-probedisk
fi

ALLDRVS=$(ls /sys/block | grep -E '^scd|^sd|^mmc|^sr')
if [ -e /proc/ide ] ; then
  ALLDRVS="$ALLDRVS
$(ls /proc/ide | grep '^hd')"
fi

for p in ${ALLDRVS} ; do
	#case $p in ram*|nbd*|loop*) continue;; esac
	vendor="" model="" type="drive"
	read vendor < /sys/block/$p/device/vendor
	read model < /sys/block/$p/device/model
	info="$vendor $model"
	case $p in
		hd*) ## ide device, look in /proc/ide for info
			read -r media < /proc/ide/$ONEDRV/media
			[ "$media" = "cdrom" ] && type="optical"
			;;
		fd*)  type=floppy  ;;
		sr*)  type=optical ;;
		mmc*) type=card ; info="MMC/SD: $info" ;;
	esac
	readlink /sys/block/$p | grep -q usb && {
		type=usbdrv
		echo "$p" >> $HOME/.usb-drive-log-probedisk
		sorted="$(sort -u $HOME/.usb-drive-log-probedisk)"
		echo "$sorted" > $HOME/.usb-drive-log-probedisk
	}
	echo "/dev/$p|$type|$info"
done

### END ###