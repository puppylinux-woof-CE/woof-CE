#!/bin/sh
#LGPL 2007 Puppy Linux www.puppyos.com
#based on probedisk3 written by Dougal.
# 21 Jun 2007 BK: force /proc update for usb drives.
#v3.93 10 dec 2007 BK: updated for 2.6.24 kernel, no /dev/hd*.
#v406 support for old kernel, /proc/ide, /dev/hd*.
# DEVICE|TYPE|INFO

output=1
case $1 in
	-alt)  output=2 ; shift ;;
	-type) output=3 ; shift ;;
	-desc) output=4 ; shift ;;
	-size) output=5 ; shift ;;
	-alt512) output=6 ; shift ;;
	-alt2048)output=7 ; shift ;;
	-alt4096)output=8 ; shift ;;
esac

device=${1##*/}

if [ -b "/dev/$device"  ] ; then
	ONLYONE=1
	[ -e /proc/ide ] && PROCIDE=1
	ALLDRVS=${device}
else
	if [ -f $HOME/.usb-drive-log-probedisk ] ; then #force /proc upate mechanism
	  while read ONEUSBDRV ; do
		dd if=/dev/$ONEUSBDRV of=/dev/null bs=512 count=1 &>/dev/null
	  done < $HOME/.usb-drive-log-probedisk
	fi

	# mounted drives/partitions...
	MNTDDEVS="`mount | cut -f 1 -d ' ' | cut -f 3 -d '/' | grep -E '^hd|^sd|^scd|^sr|^mmc' | tr '\n' ' '`"

	if [ -e /proc/ide ] ; then
		PROCIDE=1
		ALLDRVS="`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr' | tr '\n' ' '``ls -1 /proc/ide | grep '^hd' | tr '\n' ' '`"
	else
		ALLDRVS="`ls -1 /sys/block | grep -E '^scd|^sd|^mmc|^sr' | tr '\n' ' '`"
	fi
fi

###############################################################

for p in ${ALLDRVS} ; do

	#case $p in ram*|nbd*|loop*) continue;; esac
	vendor="" model="" type="drive"
	[ -f /sys/block/$p/device/vendor ] && read vendor < /sys/block/$p/device/vendor
	[ -f /sys/block/$p/device/model ] && read model < /sys/block/$p/device/model
	[ -f /sys/block/$p/size ] && read size < /sys/block/$p/size
	info="$vendor $model"
	case $p in
		hd*) ## ide device, look in /proc/ide for info
			read -r media < /proc/ide/$p/media
			[ "$media" = "cdrom" ] && type="optical"
			[ -f /proc/ide/$p/model ] && read info < /proc/ide/$p/model
			;;
		sd*) [ "$PROCIDE" ] && type=usbdrv ;; ## /proc/ide: usb drives appear as sdX)
		fd*)      type=floppy  ;;
		scd*|sr*) type=optical ;; #scd*: probably old stuff
		mmc*)     type=card ; info="MMC/SD: $info" ;;
	esac
	readlink /sys/block/$p | grep -q usb && type=usbdrv

	## Legacy stuff
	if [ "$type" = "usbdrv" ] ; then
		echo "$p" >> $HOME/.usb-drive-log-probedisk
		sorted="$(sort -u $HOME/.usb-drive-log-probedisk)"
		echo "$sorted" > $HOME/.usb-drive-log-probedisk
		# find out if a usb floppy drive...
		if [ -e /sys/block/${p}/size ];then
			[ "`cat /sys/block/${p}/size`" = "2880" ] && type=floppy
		fi
		# if the floppy diskette not inserted, try this fallback test...
		# some examples: Vendor: NEC Model: USB UF000x Rev: 1.50, Sony USB Floppy Drive, rev 1.10/5.01,
		# MITUMI USB FDD, VenDor: TEAC Model: FD-05PUB, Vendor: COMPAQ Model: USB EXT FLOPPY
		if [ -e /sys/block/${p}/device/model ];then
			[ "`grep -E ' FDD| UF000x|Floppy|USB\-FDU|^FD\-|FLOPPY' /sys/block/${p}/device/model`" != "" ] && type=floppy
		fi	
	else
		case $p in sd*)
			# find out if it is a removable internal drive (zip, ls120, etc)...
			if [ -e /sys/block/${p}/removable ];then
				[ "$(< /sys/block/${p}/removable)" = "1" ] && type=floppy
			fi
		esac
	fi

	case $output in
		1) echo "/dev/$p|$type|$info" ;;
		2) echo "/dev/$p $type $size $info" ;;
		3) echo "$type" ;;
		4) echo "$info" ;;
		5) echo "$size" ;;
		6) echo "/dev/$p $type $(filesize -bytes=512 $size) $info" ;;
		7) echo "/dev/$p $type $(filesize -bytes=2048 $size) $info" ;;
		8) echo "/dev/$p $type $(filesize -bytes=4096 $size) $info" ;;
	esac

done

###############################################################

if [ ! "$ONLYONE" ] ; then
	# find out if a mounted device has been unplugged...
	# for hotplug drives, remove it and it will disappear from /sys/block, however
	# still shows up in 'mount' if hasn't been unmounted.
	for ONEMNTD in $MNTDDEVS ; do
		case $ONEMNTD in
			hd*|sd*|sr*) MNTDDRVs="`echo -n "$ONEMNTD" | cut -b 1-3` " ;;
			scd*) MNTDDRVs="`echo -n "$ONEMNTD" | cut -b 1-4` " ;;
			mmc*) MNTDDRVs="`echo -n "$ONEMNTD" | cut -b 1-7` " ;;
		esac
		#prints to system log and to stderr...
		[ "`echo "$ALLDRVS" | grep "$MNTDDRVs"`" = "" ] && logger -s "PROBEDISK ERROR: MOUNTED UNPLUGGED $ONEMNTD"
	done
fi

### END ###