#!/bin/bash

# wl_colpick

# requires gtkdialog, grim, slurp, netpbm, grep, sed
# GPLv2

# simple conversion hex to decimal
find_color() {
	printf "%d" "0x${1}"
}

usage() {
	echo "${0##*\/} [FF0000]
	parse a hex six digit color string without leading '#'
	to rgb() format.

	With no args starts a color picker GUI."
	exit
}

export -f find_color usage

# rgb GUI
if [ -n "$1" -a "${1:0:1}" != '-' -a ${#1} -eq 6 ];then
	BCOL=$1
	echo 'window {
 background-color:#'$BCOL';
}' > /tmp/wl_colpick.css
	BR=${BCOL:0:2}; BG=${BCOL:2:2}; BB=${BCOL:4:2};
	BHR=$(find_color $BR)
	BHG=$(find_color $BG)
	BHB=$(find_color $BB)
	ZC='rgb('$BHR','$BHG','$BHB')'
	echo '<window title="Color Picker - RGB" icon-name="select-color" resizable="false" height-request="180" width-request="300">
	<vbox>
		<hbox>
			<text use-markup="true" max-width-chars="50"><label>"<span background='"'#BBBBBB'"'>Copy and paste the RGB color string below.</span>"</label></text>
		</hbox>	
		<hbox space-expand="true" space-fill="true">	
			<text selectable="true" use-markup="true"><label>"<big><big>'$ZC'</big></big>"</label></text>
		</hbox>
		<hbox space-expand="false" space-fill="false">	
			<button ok></button>
		</hbox>
	</vbox>
</window>' | gtkdialog -s --styles=/tmp/wl_colpick.css >/dev/null 2>&1 && exit
elif [ -n "$1" -a "${1:0:1}" = '-' ];then
	usage
fi

# choice GUI
export CGUI='<window title="Color Picker" icon-name="select-color" resizable="false">
	<vbox>
		<hbox space-expand="true" space-fill="true">
			<text>
				<label>Click the place on screen where you want to fetch the color</label>
			</text>
			<button image-position="2">
				<height>40</height>
				<input file icon="select-color"></input>
				<action>exit:SCREEN</action>
			</button>
		</hbox>
		<hseparator></hseparator>
			<text use-markup="true">
				<label>"<big>OR</big>"</label>
			</text>
		<hseparator></hseparator>
		<hbox space-expand="true" space-fill="true">
			<text>
				<label>Choose a color from the color button palette, select and press Ok</label>
			</text>
			<colorbutton>
				<default>#FF00FF</default>
				<variable>CHOSEN</variable>
			</colorbutton>
		</hbox>
		<hseparator></hseparator>
		<hbox>
			<button ok></button>
		</hbox>
	</vbox>
</window>'

eval $(gtkdialog -p CGUI)

case $EXIT in
	# needs sleep, dunno why
	SCREEN)C=$(pos="$(slurp -b FFFFFF00 -p)";sleep 1; grim -g "$pos" -t ppm - | ppmtoxpm | grep -m1 '" c.*"' | sed -e 's/\" c //' -e 's/\".*$//')
	;;
	OK)C=$CHOSEN
	echo $C;;
	*)exit;;
esac

# bg color
echo 'window {
 background-color:'$C';
}' > /tmp/wl_colpick.css

XTRA_BTN=''
case "$C" in
	*1*1*1*|""|white|black|?F*F*F*)ISITOK='Is this color OK? Sometimes this app fails but you can try again. Try moving the cursor immediately after pressing selection.'
	XTRA_BTN='<button>
		<label>Try Again</label>
		<input file icon="refresh"></input>
		<action>exec wl_colpick &</action>
		<action>exit:Quit</action>
	</button>'
	;;
	*)
	if [ "${C:0:1}" = '#' ]; then
		Z=${C/\#/} # remove leading '#'
		XTRA_BTN='<button>
		<label>Convert to rgb()</label>
		<input file icon="refresh"></input>
		<action>exec wl_colpick '$Z' &</action>
		<action>exit:Quit</action>
	</button>'
		RGB='or convert to <b>rgb()</b>'
	fi
	;;
esac

# return GUI
echo '<window title="Color Picker" icon-name="select-color" resizable="false" height-request="180" width-request="300">
	<vbox>
		<hbox>
			<text use-markup="true" max-width-chars="50"><label>"<span background='"'#BBBBBB'"'>Copy and paste the selected color string below '$RGB'. '$ISITOK'</span>"</label></text>
		</hbox>	
		<hbox space-expand="true" space-fill="true">	
			<text selectable="true" use-markup="true"><label>"<big><big>'$C'</big></big>"</label></text>
		</hbox>
		<hbox space-expand="false" space-fill="false">	
			'$XTRA_BTN'
			<button ok></button>
		</hbox>
	</vbox>
</window>' | gtkdialog -s --styles=/tmp/wl_colpick.css >/dev/null 2>&1
