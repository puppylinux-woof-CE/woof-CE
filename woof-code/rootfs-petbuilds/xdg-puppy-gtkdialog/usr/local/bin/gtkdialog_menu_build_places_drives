#!/bin/bash

. /etc/rc.d/functions_x

mounted_part() {
	grep -q $1 /etc/mtab && return 0 || return 1
}
home_part() {
	grep "$1" /etc/mtab | grep -q '\/initrd\/mnt/dev_save' && return 0 || return 1
}
find_mt_pt() {
	read e f g <<<$(grep $1 /etc/mtab)
	echo "$f"
}

echo "<menu label=\"Drives\" image-name=\"/usr/local/lib/X11/pixmaps/drive48.png\">"
while read a b c d
do
	H=''
	PARTITION=$d
	DRIVE=$(fx_get_drvname $PARTITION)
    case $PARTITION in
    sd[a-z][0-9]*|nvme[0-9]n[0-9]p[0-9]*)
        fx_drv_is_usb "$DRIVE" && MEDIA="usbdrv" || MEDIA="drive" 
        if mounted_part "$PARTITION" ; then
			MNTD='_mntd'
			MTPT=$(find_mt_pt ${PARTITION})
			ACT="defaultfilemanager ${MTPT}"
		else
			MNTD=''
			ACT="/usr/local/pup_event/drive_all ${PARTITION}"
        fi
        if home_part "$PARTITION" ; then
			BOOT='_boot'
			H='(home)'
			ACT="defaultfilemanager /mnt/home"
		else
			BOOT=''
			ACT="/usr/local/pup_event/drive_all ${PARTITION}"
		fi
        FILESYSTEM=$(guess_fstype /dev/$PARTITION 2>/dev/null)
        [ "$FILESYSTEM" = 'swap' -o "$FILESYSTEM" = 'unknown' ] && continue
        INFO="`cat /sys/block/$DRIVE/device/model`"
        ;;
    scd*|sr*)
        if cddetect_quick >/dev/null 2>&1 ; then
            MEDIA="optical"
            MNTD='';BOOT=''
            ACT="/usr/local/pup_event/drive_all ${PARTITION}"
            FILESYSTEM="iso9660"
            INFO=""
        else
            continue
        fi
        ;;
    mmc*)
        MEDIA="card"
        FILESYSTEM=$(guess_fstype /dev/$PARTITION)
        INFO="MMC/SD: `cat /sys/block/$DRIVE/device/name`"
         if mounted_part "$PARTITION" ; then
			MNTD='_mntd'
			MTPT=$(find_mt_pt ${PARTITION})
			ACT="defaultfilemanager ${MTPT}"
		else
			MNTD=''
			ACT="/usr/local/pup_event/drive_all ${PARTITION}"
        fi
        if home_part "$PARTITION" ; then
			BOOT='_boot'
			ACT="defaultfilemanager /mnt/home"
		else
			BOOT=''
		fi       
        ;;
    *)
        continue
        ;;
    esac
    echo "
    <menuitem label=\"${PARTITION} $H  ${FILESYSTEM}   ${INFO}\" image-name=\"/usr/local/lib/X11/pixmaps/${MEDIA}${MNTD}${BOOT}48.png\">
	    <height>32</height>
	    <action>$ACT &</action>
	    <action>exit:Quit</action>
	</menuitem>
	" 
done < /proc/partitions
echo "<menuitemseparator>
	</menuitemseparator>
	<menuitem label=\"Unmount\" image-name=\"/usr/share/pixmaps/puppy/arrow_mini_up.svg\">
		<height>20</height>
		<action>pmount &</action>
		<action>exit:Quit</action>
	</menuitem><height>20</height>
	</menu>"
